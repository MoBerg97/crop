---
title: "Crop data"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Packages

```{r packages}
require(data.table)
require(sf)
require(mapview)
require(stringr)
require(plyr)
require(dplyr)
require(ggplot2)
require(forcats)
require(tidyr)
```

## Harvest data
(1) A list named fl_vec of every name of the datatables in the data/nrw directory was created 
(2) A new list named l was created
(3-5) Every table from the data named as the strings in the list fl_vec was implemented in a dataframe named dat
(6) The first row  was dropped, but why?
(7) The names for the first two columns representing the district number and the district name were set to 'rs' and 'gen'
(8) The list l was filled with the rows, each containing a dataframe from dat for every year
(9) the names of the rows in l are reduced from the data name to only the yearnumber
(10) rbindlist stacked all the data.frames of the list l to a single data.frame and labeled the id column to year

```{r data-harvest}
# read list of files
fl_vec = list.files('data/nrw', pattern = 'csv', full.names = TRUE)
l = list()
for (i in seq_along(fl_vec)) {
  fl = fl_vec[i]
  dat = fread(fl, skip = 7, header = TRUE, encoding = 'Latin-1', stringsAsFactors = FALSE)
  dat = dat[-1, ]
  setnames(dat, 1:2, c('rs', 'gen'))
  
  l[[i]] = dat
  names(l)[i] = gsub('ernte|.csv', '', basename(fl))
}
# bind list of data.table to one data.table
dt = rbindlist(l, fill = TRUE, idcol = 'year')

# remove special symbols and convert column types to numeric
dtc = data.frame(dt)
for(i in 4:41){
  dtc[,i] =  gsub('[-.x]','0',dtc[,i])
  dtc[,i] = gsub('[,]','.',dtc[,i])
}
for(i in 4:41){
  dtc[,i] = as.numeric(dtc[,i])
}
# bring data into long format (year, rs, gen as identifier variables)
crop_names = colnames(dtc[,4:41])
setDT(dtc)
str(dtc)
dtc_long = melt(dtc, id.vars = c("year","rs","gen"), measure.vars = crop_names, variable.name = 'crop', value.name = 'dt.ha' )
```

(1) Shapefiles der Kreise Deutschlands werden eingelesen.
(2) Namen der Spalten werden alle nun klein geschrieben
(3) rs der Kreise soll als numeric typisiert sein --> merge mit rs aus dtc
(4) kreis2 ist Tabelle aus Kopie der Spalten rs, rs_alt, ... von kreis
(5) zeigt die Karte an

```{r data-spatial-regions}
kreis = st_read(file.path('data', 'germany_kreis.shp'), stringsAsFactors = FALSE)
setnames(kreis, tolower(names(kreis)))
kreis$rs = as.numeric(kreis$rs)
kreis2 = kreis[ , names(kreis) %in% c('rs', 'rs_alt', 'geom', 'shape_leng', 'shape_area') ]
# mapview(kreis2) # to have an interactive look at the geo data

# refine to NRW only
kreis3 = kreis2[0,]
for (i in 1:402){
  if (kreis2$rs[i]>5000 & kreis2$rs[i]<6000){
  # add_row(kreis3)
    rbind(kreis3)
  kreis3[nrow(kreis3)+1,] = kreis2[i,]
  }
}
# mapview(kreis3)
```

```{r merge}
# merge geo and crop data
fin = merge(kreis3, dtc_long)

# shorten crop names
cropnms = gsub('[.]', ' ', crop_names)
cropnms[1] = 'Getreidemit'
cropnms[2] = 'Getreideohne'
cropnms[7] = 'Hartweizen'
cropnms[8] = 'Roggenmit'
cropnms[11] = 'Futtergetreide'
cropnms[10] = 'Wintergetreide'
cropnms[16] = 'Sommergetreide'
cropnms[18] = 'Körnermaismit'
cropnms[21] = 'Spätkartoffeln'
cropnms[24] = 'Leguminosen'
cropnms[25] = 'Erbsen'
cropnms[28] = 'Sommerraps'
cropnms[31] = 'Getreideganz'
cropnms[33] = 'Weiden'
cropnms[34] = 'Feldgras'
cropnms[35] = 'Klee'
cropnms[37] = 'Silomais'

# rename crops

fin$crop = mapvalues(fin$crop, from = crop_names, to = cropnms)

#crop categories
# Getreide = 'Getreidemit' , 'Getreideohne' ,  'Brotgetreidearten' , 'Wintergetreide' , 'Futtergetreide' ,  'Sommergetreide' , 'Titricale'
# Weizen = 'Winterweizen' , 'Sommerweizen'  , 'Getreideganz' , 'Hartweizen', 'Weizen'
# Roggen = 'Roggenmit' , 'Roggen'
# Gerste = 'Gerste', 'Wintergerste', 'Sommergerste'
# Hafer = 'Hafer'
# Mais = 'Körnermais' , 'Silomais'
# Kartoffeln = 'Frühkartoffeln', 'Kartoffeln', 'Spätkartoffeln'
# Rüben = 'Zuckerrüben', 'Runkelrüben'
# RapsSonne = 'Winterraps', 'Sommerraps', 'Sonnenblumen'
# Leguminosen = 'Leguminosen', 'Erbsen', 'Ackerbohnen', 'Klee', 'Luzerne', 'Süßlupinen'
# Gras = 'Wiesen', 'Weiden', 'Feldgras', 'Rauhfutter'

#create duplicate of fin with crops categorized
fin2 = fin
fin2$crop = mapvalues(fin2$crop, from= c('Getreidemit','Getreideohne','Brotgetreidearten','Wintergetreide','Futtergetreide','Sommergetreide','Triticale'), to= c('Getreide','Getreide','Getreide','Getreide','Getreide','Getreide','Getreide'))
fin2$crop = mapvalues(fin2$crop, from= c('Winterweizen','Sommerweizen','Getreideganz','Hartweizen','Weizen'), to= c('Weizen','Weizen','Weizen','Weizen','Weizen'))
fin2$crop = mapvalues(fin2$crop, from= c('Roggenmit','Roggen'), to=c('Roggen','Roggen'))
fin2$crop = mapvalues(fin2$crop, from= c('Gerste','Wintergerste','Sommergerste'), to= c('Gerste','Gerste','Gerste'))
fin2$crop = mapvalues(fin2$crop, from= c('Körnermaismit','Silomais'),to= c('Mais','Mais'))
fin2$crop = mapvalues(fin2$crop, from= c('Frühkartoffeln','Kartoffeln','Spätkartoffeln'),to= c('Kartoffeln','Kartoffeln','Kartoffeln'))
fin2$crop = mapvalues(fin2$crop, from= c('Zuckerrüben','Runkelrüben'),to= c('Rüben','Rüben'))
fin2$crop = mapvalues(fin2$crop, from= c('Winterraps','Sommerraps','Sonnenblumen'),to= c('RapsSonne','RapsSonne','RapsSonne'))
fin2$crop = mapvalues(fin2$crop, from= c('Leguminosen','Erbsen','Ackerbohnen','Klee','Luzerne','Süßlupinen'),to= c('Leguminosen','Leguminosen','Leguminosen','Leguminosen','Leguminosen','Leguminosen'))
fin2$crop = mapvalues(fin2$crop, from= c('Wiesen','Weiden','Feldgras','Rauhfutter'),to= c('Gras','Gras','Gras','Gras'))


# consolidate rows with allover same values, but different dt.ha
fin2 = fin2 %>%
  group_by(rs,shape_area,geom,year,gen,crop) %>%
  summarise(dt.ha = sum(dt.ha,na.rm = TRUE))

cropnms2 = unique(fin2$crop)
```

## Manipulate data and visualize

```{r manipulate}
# Durchschnittsertrag je Feldfrucht in ganz NRW
mn_crop = fin %>% 
  group_by(crop) %>%
  summarise(mn_dt = mean(dt.ha))

ggplot(mn_crop, aes(x=crop,y=mn_dt)) + 
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, size = 9, vjust = 0))+
  scale_x_discrete(labels=cropnms)

# Durchschnittsertrag je Kreis
mn_kreis = fin %>%
  group_by(gen) %>%
  summarise(mean(dt.ha))

mapview(mn_kreis)

# Durchschnittsertrag je Jahr
mn_jahr = fin %>%
  group_by(year) %>%
  summarise(mean(dt.ha))

# Durchschnittsertrag je Jahr je Feldfrucht

mn_cropjahr = fin %>%
  group_by(year, crop) %>%
  summarise(mean(dt.ha))

#FOLGENDES MACHT KEINEN SINN DA ERTRAG JA SCHON PRO FLÄCHE IST
# # Durchschnittsertrag je Kreis pro Fläche mit anständiger Formel
# mn_kreispa = fin %>%
#   group_by(gen) %>%
#   summarise(mn_dt = mean(dt.ha)/mean(shape_area)) #!!!
# 
# plot(mn_kreispa)

# Durchschnittsertrag je Feldfrucht je Kreis 
mn_cropkreis = fin %>%
  group_by(crop, gen) %>%
  summarise(mean(dt.ha))
  
# Durchschnittsertrag je wichtige Feldfrucht pro Kreis
for (i in 1:length(cropnms2)){
mn_cropkreis2 = fin2 %>%
  group_by(crop,gen) %>%
  summarise(mn_dt = mean(dt.ha)) %>%
  filter(crop == cropnms2[i])
  
print(
  ggplot(data = mn_cropkreis2) +
  geom_sf(aes(fill = mn_dt)) + 
  ggtitle(cropnms2[i], subtitle = 'yield in dt per ha')
)
}
# Ertrag für Winter / Sommer crops
wintercrops = c('Winterweizen','Winterraps',)
mn_Winter = fin %>%
  group_by()

# TODO Auswahl der Kategorien und Berechnung eines Index


# TODO Visualisierung

```

## Merge with pesticide data

To compare the crop yield with the pesticide usage, the sum of pesticide sample values were calculated for each district.

```{r data-spatial-pesticides}
nrw2 = readRDS(file.path('data/nrw', 'nrw_sites.rds')) # spatial sites data
nrw_sam = readRDS(file.path('data/nrw', 'nrw_samples.rds')) # pesticide samples

nrw_sam$site_id = gsub('_....-..-..','',nrw_sam$sample_id)

pest = merge(nrw2, nrw_sam)

# #Summe der Messwerte pro Site
# sum_pest = pest %>%
#   group_by(site_id) %>%
#   mutate(sum_value = sum(value, na.rm = TRUE))
# 
# sum_district = sum_pest %>%
#   group_by(gen)

#TODO Intersection --> Karte der Pestizide mit intensiver LW-Fläche vergleichen
st_crs(pest)
st_crs(mn_kreis)
mn_kreis = st_transform(mn_kreis, crs = st_crs(pest))
pestcrop = st_intersection(pest, mn_kreis)

#TODO calculate sum of pest sample values for each district

#TODO Visualisierung

```

## Tasks

- Part1:
  - Clean crop data
  - Merge with spatial data
  - Aggregate crop data
  - Select 5-10 regions (i.e. Kreis) with the most agriculture
  - Visualize regions with intensive agriculture

- Part2:
  - Intersect with pesticide sampling sites
  - Look if sites with high concentrations intersect well with regions (i.e. Kreis) with high agriculture
  - Visualize this

- Document this in R-Markdown
- Presentation?


