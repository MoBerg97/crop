---
title: 'Crop data'
output: html_document
editor_options: 
  chunk_output_type: console
---

## Packages

```{r packages}
require(data.table)
require(sf)
require(mapview)
require(stringr)
require(plyr)
require(dplyr)
require(ggplot2)
require(forcats)
require(tidyr)
require(tmap)
require(grid)
require(gridExtra)
require(RColorBrewer)
```

## Harvest data

```{r data-harvest}
# read list of files
fl_vec = list.files('data/nrw', pattern = 'csv', full.names = TRUE)
l = list()
for (i in seq_along(fl_vec)) {
  fl = fl_vec[i]
  dat = fread(fl, skip = 7, header = TRUE, encoding = 'Latin-1', stringsAsFactors = FALSE)
  dat = dat[-1, ]
  setnames(dat, 1:2, c('rs', 'gen'))
  
  l[[i]] = dat
  names(l)[i] = gsub('ernte|.csv', '', basename(fl))
}
# bind list of data.table to one data.table
dt = rbindlist(l, fill = TRUE, idcol = 'year')
# remove special symbols and convert column types to numeric
cols = names(dt)[ ! names(dt) %in% c('year', 'rs', 'gen')]
dt[ , (cols) := lapply(.SD, function(x) gsub('\\.|-', NA, x)),
    .SDcols = cols ]
dt[ , (cols) := lapply(.SD, function(x) gsub(',', '.', x)),
    .SDcol = cols ]
dt = dt %>%
  mutate_at(c(4:41), ~as.numeric(.)) %>%
  mutate_at(c(4:41), ~replace(.,is.na(.),0))
# bring data into long format (year, rs, gen as identifier variables)
crop_names = colnames(dt[,4:41])
setDT(dt)
dt_long = melt(dt, id.vars = c('year','rs','gen'), measure.vars = crop_names, variable.name = 'crop', value.name = 'dtha' )
```

```{r data-spatial-regions}
kreis = st_read(file.path('data', 'germany_kreis.shp'), stringsAsFactors = FALSE)
setnames(kreis, tolower(names(kreis)))
kreis$rs = as.numeric(kreis$rs)
kreis2 = kreis[ , names(kreis) %in% c('rs', 'rs_alt', 'geom', 'shape_leng', 'shape_area') ]
# refine to NRW only
nrw <- kreis2 %>% 
  filter(substr(rs_alt,1,2) == "05")
#nrw as a whole geometry for visualization purposes
nrw_full = st_union(st_geometry(nrw))
```
According to the german district number, formally called 'Amtlicher Gemeindeschlüssel' and referenced by rs_alt, the first to digits '05' indicate the federal state 'North Rhine-Westphalia'.

To organize the data, the crops were renamed and categorized in another column into 12 factors.
```{r merge and categorize}
# merge geo and crop data
fin = merge(nrw, dt_long)
# shorten crop names
cropnms = gsub('[.]', ' ', crop_names)
cropnms[1] = 'GetreidemitCCM'
cropnms[2] = 'GetreideohneCCM'
cropnms[7] = 'Hartweizen'
cropnms[8] = 'RoggenmitWG'
cropnms[11] = 'Futtergetreide'
cropnms[10] = 'Wintergetreide'
cropnms[16] = 'Sommergetreide'
cropnms[18] = 'KörnermaismitCCM'
cropnms[21] = 'Spätkartoffeln'
cropnms[24] = 'Leguminosen'
cropnms[25] = 'Erbsen'
cropnms[28] = 'Sommerraps'
cropnms[31] = 'Getreideganz'
cropnms[33] = 'Weiden'
cropnms[34] = 'Feldgras'
cropnms[35] = 'KleeLuzerne'
cropnms[37] = 'Silomais'
# rename crops
fin$crop = mapvalues(fin$crop, from = crop_names, to = cropnms)
# categorize crops
fin = fin %>%
  mutate(cropcat = case_when(crop %in% c('GetreidemitCCM','GetreideohneCCM','Brotgetreidearten','Wintergetreide','Futtergetreide','Sommergetreide','Triticale') ~ 'cereal',
        crop %in% c('Winterweizen','Sommerweizen','Getreideganz','Hartweizen','Weizen') ~ 'wheat',
        crop %in% c('RoggenmitWG','Roggen') ~ 'rye',
        crop %in% c('Gerste','Wintergerste','Sommergerste') ~ 'barley',
        crop %in% c('Hafer') ~ 'oat',
        crop %in% c('KörnermaismitCCM','Silomais') ~ 'maize',
        crop %in% c('Frühkartoffeln','Kartoffeln','Spätkartoffeln') ~ 'potatoes',
        crop %in% c('Zuckerrüben','Runkelrüben') ~ 'beets',
        crop %in% c('Winterraps','Sommerraps') ~ 'rapeseed',
        crop %in% c('Sonnenblumen') ~ 'sunflower',
        crop %in% c('Leguminosen','Erbsen','Ackerbohnen','KleeLuzerne','Luzerne','Süßlupinen') ~ 'legumes',
        crop %in% c('Wiesen','Weiden','Feldgras','Rauhfutter') ~ 'grassland'))
cropcatnms = unique(fin$cropcat)
```

## Manipulate data and visualize
A first look at the distribution of yield per crop was useful to sort out minor crops. Additionally our categorization was checked regarding the distribution of the average yield of all included crops of each category. 

```{r overview crops}
# average yield per crop
mn_crop = fin %>% 
  group_by(crop,cropcat) %>%
  summarise(mn_dt = mean(dtha)) %>%
  arrange(cropcat)

# TODO arrange plot for crop categories HOW?
ggplot(mn_crop, aes(x=crop,y=mn_dt,  fill = cropcat)) + 
  geom_bar(stat = 'identity', width = 0.8) +
  labs(fill = 'crop category', y = 'dt/ha', x = '') +
  ggtitle('Fig.1 Average yield of crops') +
  scale_fill_brewer(palette='Paired') +
  theme(axis.text.x = element_text(angle = 45, size = 9, vjust = 1, hjust = 1)) 

ggplot(mn_crop, aes(x=cropcat,y=mn_dt,  fill = cropcat)) + 
  geom_bar(stat = 'identity', width = 0.8) +
  labs(fill = 'crop category', y = 'dt/ha', x = '') +
  ggtitle('Fig.2 Average yield per crop category') +
  scale_fill_brewer(palette='Paired') +
  theme(axis.text.x = element_text(angle = 45, size = 9, vjust = 1, hjust = 1), legend.position ='none')
```

The graphics show, that a cumulation of wheat, rye, oats to one group called cereals would be better comparable to other major crops. Other crop categories like legumes, rapeseed and sunflower can be disregarded due to low yield and unsuitable assignment to other categories.

```{r categorize 2}
fin = fin %>%
  mutate(cropcat2 = case_when(crop %in% c('cereal','wheat','rye','barley','oat') ~ 'cereal',
                             crop %in% c('legumes','rapeseed','sunflower','grassland') ~ 'other'))
cropcatnms2 = na.omit(unique(fin$cropcat2))
```

```{r overview year}
# average yield per year
mn_jahr = fin %>%
  group_by(year,cropcat2) %>%
  summarise(mn_dt = mean(dtha))

ggplot(mn_jahr, aes(x=year,y=mn_dt, fill=cropcat2)) + 
  geom_bar(position='stack', stat = 'identity', width =0.8) +
  ggtitle('Fig.3 Average yield per year') +
  theme(axis.text.x = element_text(angle = 45, size = 9, vjust = 1, hjust = 1))
# average yield per crop per year
# TODO have both colour codings in legend
mn_cropjahr = fin %>%
  group_by(year, crop, cropcat, cropcat2) %>%
  summarise(mn_dt = mean(dtha))
bigcrop = filter(mn_cropjahr,mn_dt>100)
smallcrop = filter(mn_cropjahr,mn_dt<100)

cropjahrlegend = cbind(unique(bigcrop$crop),c('other'))
ggplot() +
  geom_point(aes(x=year, y=mn_dt, colour = crop), bigcrop) +
  geom_line(aes(x=year, y=mn_dt,group = crop, colour = crop), bigcrop) +
  geom_point(aes(x=year, y=mn_dt), smallcrop, colour='grey50') +
  geom_line(aes(x=year, y=mn_dt,group = crop), smallcrop, colour='grey50') +
  ggtitle('Fig.4 Average yield of crops for each year from 2005 to 2015') +
  scale_colour_manual(name  ='crop', values=c('#CC0000','#CC6600','#FFFF00','#00CCCC','#0066CC','#0000CC'), labels=cropjahrlegend) +
  theme(axis.text.x = element_text(angle = 45, size = 9, vjust = 0))

#crop yield for the three yearspans mapped to districts
cropyearspan1 = fin %>%
  filter(year<2010) %>%
  group_by(gen) %>%
  summarise(mn_dt=mean(dtha))
cropyearspan2 = fin %>%
  filter(year>=2010) %>%
  group_by(gen) %>%
  summarise(mn_dt=mean(dtha))
tm_compass() + tm_scale_bar() + tm_shape(cropyearspan1) + tm_sf('mn_dt', palette='RdYlBu', breaks = c(0,30,60,90,120,150,180), id='dt/ha', title='dt/ha')  + tm_shape(nrw) + tm_borders(lwd = 2, col='grey30')+ tm_layout(title='Fig.5 Average yield per district from 2005 to 2009', title.bg.color=TRUE)
tm_compass() + tm_scale_bar() + tm_shape(cropyearspan2) + tm_sf('mn_dt', palette='RdYlBu', breaks = c(0,30,60,90,120,150,180), id='dt/ha', title='dt/ha')  + tm_shape(nrw) + tm_borders(lwd = 2, col='grey30')+ tm_layout(title='Fig.6 Average yield per district from 2010 to 2015', title.bg.color=TRUE)
```

The graph in figure 4 shows, that some previously largely harvested crops fell significantly in yield below the 100 dt per ha mark in 2007 and 2009. This either indicates corrupted data, deviating data acquisition forms or actual drop of yield for those  specific crops. One possible reason could be the EU's energy crop directive of 2009 (EU2009 --> Official Journal of the European Union, https://eur-lex.europa.eu/LexUriServ/LexUriServ.do?uri=OJ:L:2009:140:0016:0062:EN:PDF)
Therefore the final dataframe was refined to only include data of years after 2009.

To have a glimpse over the geogrpahical distribution of yield districtwise we plotted a map-visual approach and a facet-barplot approach. We used the abbreviations of districts for license plates to shorten the district names for plots. The assignment code can be found below (dataframe 'abbcode').

```{r crops of district}
#abbreviation of districts
fin = fin %>%
  mutate(gn = plyr::mapvalues(gen, 
            from= unique(fin$gen), 
            to=c('D','DU','E','KR','MG','MH','OB','RS','SG','W','KLE','ME','NE','VIE','WES','BN','K','LEV','AC','DN','BM','EU','HS','GM','GL','SU','BOT','GE','MS','BOR','COE','RE','ST','WAF','BI','GT','HF','HX','LIP','MI', 'PB', 'BO','DO','HA','HAM','HER','EN','HSK','LS','OE','SI','SO','UN')))
abbcode = data.frame(gen = unique(fin$gen), gn = unique(fin$gn))
abbcode
#TODO get tm_facets working
mn_cropkreis = fin %>%
  na.omit() %>%
  group_by(cropcat2, gen, gn) %>%
  summarise(mn_dt = mean(dtha)) 

tm_layout(title='Fig.7 Average yield per district per crop category', title.bg.color=TRUE) +
  tm_shape(nrw) + 
  tm_borders(lwd = 2, col='grey30')+ 
  tm_compass() + tm_scale_bar() + 
tm_shape(mn_cropkreis) + 
  tm_sf('mn_dt', palette='RdYlBu') + 
  tm_facets(by='cropcat2')

# facetting approach for yield per crop per district barplot
#TODO show with visual effect (red border, ..) which districts get sorted out
mn_cropkreisf = fin %>%
  na.omit() %>%
  group_by(cropcat2,gn) %>%
  summarise(mn_dt = mean(dtha))
ggplot(mn_cropkreisf, aes(x=cropcat2, y=mn_dt, fill = cropcat2))+
  geom_bar(stat='identity') +
  facet_wrap(~gn, ncol = 10) +
  labs(fill = 'crop category', y = 'dt/ha', x = '') +
  ggtitle('Fig.8 Average yield per crop category for each district') + 
  scale_fill_brewer(palette='RdYlBu') +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size = 7))
```

```{r crop index}
# TODO better visuals: colour of bubbles as gradient, alpha fix, legend only for colour or size, legend title as index, divide values by 1000
ci = fin %>%
  #filter years 2009 and before
  filter(year>=2010) %>%
  #calculate average yield per crop per district over the 5 years
  group_by(crop,gen) %>%
  mutate(mn_dt = mean(dtha)) %>%
  ungroup() %>%
  #calculate sum of yield per district over all crops (every year contains the same values in the mn_dt column)
  group_by(year,gen) %>%
  mutate(sum_dt = sum(mn_dt))
#filter districts below the mean of the sum_dt for visualiization purposes
cisimple = ci %>%
  filter(sum_dt>=mean(unique(sum_dt)))
tm_compass() + tm_scale_bar() + tm_shape(fin) + tm_polygons() + tm_shape(cropindex) + tm_bubbles(size='sum_dtha',  col='sum_dtha', alpha=0.5, scale=3)  + tm_shape(nrw) + tm_borders(lwd = 2, col='grey30')+ tm_layout(title='Fig.9 Crop index', title.bg.color=TRUE)
```

## Merge with pesticide data

To compare the crop yield with the pesticide usage, the sum of pesticide sample values were calculated for each district.

```{r data-spatial-pesticides}
nrw2 = readRDS(file.path('data/nrw', 'nrw_sites.rds')) # spatial sites data
nrw_sam = readRDS(file.path('data/nrw', 'nrw_samples.rds')) # pesticide samples
nrw_sam$site_id = gsub('_....-..-..','',nrw_sam$sample_id)
pest = merge(nrw2, nrw_sam)
#Transformation fitting to the german EPSG: 31467 and Intersection 
st_crs(pest)
st_crs(cropindex)
cropindex = st_transform(cropindex, crs = st_crs(pest))
pestcrop = st_intersection(cropindex, pest)
#TODO barplot Pestizide mit höchsten Konzentrationen
ggplot(pest, aes(x=))
#TODO calculate pest index - Messstation mit höchstem Landwirtschaftsanteil
pestindex = pest %>%
  mutate(atkis_perc = atkis_perc*100) %>%     #agricultural proportion converted into percentage
  
#TODO visualize

```

## Tasks

- Part1:
  - Clean crop data
  - Merge with spatial data
  - Aggregate crop data
  - Select 5-10 regions (i.e. Kreis) with the most agriculture
  - Visualize regions with intensive agriculture

- Part2:
  - Intersect with pesticide sampling sites
  - Look if sites with high concentrations intersect well with regions (i.e. Kreis) with high agriculture
  - Visualize this

- Document this in R-Markdown
- Presentation?


