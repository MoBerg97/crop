---
title: 'Crop data'
output: html_document
editor_options: 
  chunk_output_type: console
---

## Packages
test
```{r packages}
require(data.table)
require(sf)
require(mapview)
require(stringr)
require(plyr)
require(dplyr)
require(ggplot2)
require(forcats)
require(tidyr)
require(tmap)
require(grid)
require(gridExtra)
require(RColorBrewer)
require(funchir) #delete after checking which packages are unused with stale_package_check('crop.Rmd')
```

## Harvest data
(1) A list named fl_vec of every name of the datatables in the data/nrw directory was created 
(2) A new list named l was created
(3-5) Every table from the data named as the strings in the list fl_vec was implemented in a dataframe named dat
(6) The first row  was dropped, but why?
(7) The names for the first two columns representing the district number and the district name were set to 'rs' and 'gen'
(8) The list l was filled with the rows, each containing a dataframe from dat for every year
(9) the names of the rows in l are reduced from the data name to only the yearnumber
(10) rbindlist stacked all the data.frames of the list l to a single data.frame and labeled the id column to year

```{r data-harvest}
# read list of files
fl_vec = list.files('data/nrw', pattern = 'csv', full.names = TRUE)
l = list()
for (i in seq_along(fl_vec)) {
  fl = fl_vec[i]
  dat = fread(fl, skip = 7, header = TRUE, encoding = 'Latin-1', stringsAsFactors = FALSE)
  dat = dat[-1, ]
  setnames(dat, 1:2, c('rs', 'gen'))
  
  l[[i]] = dat
  names(l)[i] = gsub('ernte|.csv', '', basename(fl))
}
# bind list of data.table to one data.table
dt = rbindlist(l, fill = TRUE, idcol = 'year')

# remove special symbols and convert column types to numeric
dtc = data.frame(dt)
for(i in 4:41){
  dtc[,i] =  gsub('[-.x]','0',dtc[,i])
  dtc[,i] = gsub('[,]','.',dtc[,i])
}
for(i in 4:41){
  dtc[,i] = as.numeric(dtc[,i])
}
# bring data into long format (year, rs, gen as identifier variables)
crop_names = colnames(dtc[,4:41])
setDT(dtc)
str(dtc)
dtc_long = melt(dtc, id.vars = c('year','rs','gen'), measure.vars = crop_names, variable.name = 'crop', value.name = 'dtha' )
```

(1) Shapefiles der Kreise Deutschlands werden eingelesen.
(2) Namen der Spalten werden alle nun klein geschrieben
(3) rs der Kreise soll als numeric typisiert sein --> merge mit rs aus dtc
(4) kreis2 ist Tabelle aus Kopie der Spalten rs, rs_alt, ... von kreis
(5) zeigt die Karte an

```{r data-spatial-regions}
kreis = st_read(file.path('data', 'germany_kreis.shp'), stringsAsFactors = FALSE)
setnames(kreis, tolower(names(kreis)))
kreis$rs = as.numeric(kreis$rs)
kreis2 = kreis[ , names(kreis) %in% c('rs', 'rs_alt', 'geom', 'shape_leng', 'shape_area') ]
# refine to NRW only
kreis3 = kreis2[0,]
for (i in 1:402){
  if (kreis2$rs[i]>5000 & kreis2$rs[i]<6000){
    rbind(kreis3)
  kreis3[nrow(kreis3)+1,] = kreis2[i,]
  }
}
#nrw as a whole geometry for visualization purposes
nrw = st_union(st_geometry(kreis3))
```

To organize the data, the crops were renamed and categorized in another column into 11 factors.

```{r merge and categorize}
# merge geo and crop data
fin = merge(kreis3, dtc_long)
# shorten crop names
cropnms = gsub('[.]', ' ', crop_names)
cropnms[1] = 'GetreidemitCCM'
cropnms[2] = 'GetreideohneCCM'
cropnms[7] = 'Hartweizen'
cropnms[8] = 'Roggenmit'
cropnms[11] = 'Futtergetreide'
cropnms[10] = 'Wintergetreide'
cropnms[16] = 'Sommergetreide'
cropnms[18] = 'KörnermaismitCCM'
cropnms[21] = 'Spätkartoffeln'
cropnms[24] = 'Leguminosen'
cropnms[25] = 'Erbsen'
cropnms[28] = 'Sommerraps'
cropnms[31] = 'Getreideganz'
cropnms[33] = 'Weiden'
cropnms[34] = 'Feldgras'
cropnms[35] = 'KleeLuzerne'
cropnms[37] = 'Silomais'
# rename crops
fin$crop = mapvalues(fin$crop, from = crop_names, to = cropnms)

# categorize crops
fin = fin %>%
  mutate(cropcat = plyr::mapvalues(crop, 
            from= c('GetreidemitCCM','GetreideohneCCM','Brotgetreidearten','Wintergetreide','Futtergetreide','Sommergetreide','Triticale'), 
            to= c('Getreide','Getreide','Getreide','Getreide','Getreide','Getreide','Getreide'))) %>%
  mutate(cropcat = plyr::mapvalues(cropcat, 
            from= c('Winterweizen','Sommerweizen','Getreideganz','Hartweizen','Weizen'), 
            to= c('Weizen','Weizen','Weizen','Weizen','Weizen'))) %>%
  mutate(cropcat = plyr::mapvalues(cropcat, 
            from= c('Roggenmit','Roggen'), 
            to=c('Roggen','Roggen'))) %>%
  mutate(cropcat = plyr::mapvalues(cropcat, 
            from= c('Gerste','Wintergerste','Sommergerste'), 
            to= c('Gerste','Gerste','Gerste'))) %>%
  mutate(cropcat = plyr::mapvalues(cropcat, 
            from= c('KörnermaismitCCM','Silomais'),
            to= c('Mais','Mais'))) %>%
  mutate(cropcat = plyr::mapvalues(cropcat, 
            from= c('Frühkartoffeln','Kartoffeln','Spätkartoffeln'),
            to= c('Kartoffeln','Kartoffeln','Kartoffeln'))) %>%
  mutate(cropcat = plyr::mapvalues(cropcat, 
            from= c('Zuckerrüben','Runkelrüben'),
            to= c('Rüben','Rüben')))%>%
  mutate(cropcat = plyr::mapvalues(cropcat, 
            from= c('Winterraps','Sommerraps','Sonnenblumen'),
            to= c('RapsSonne','RapsSonne','RapsSonne'))) %>%
  mutate(cropcat = plyr::mapvalues(cropcat, 
            from= c('Leguminosen','Erbsen','Ackerbohnen','KleeLuzerne','Luzerne','Süßlupinen'),
            to= c('Leguminosen','Leguminosen','Leguminosen','Leguminosen','Leguminosen','Leguminosen'))) %>%
  mutate(cropcat = plyr::mapvalues(cropcat, 
            from= c('Wiesen','Weiden','Feldgras','Rauhfutter'),
            to= c('Gras','Gras','Gras','Gras')))
cropcatnms = unique(fin$cropcat)
# TODO maybe delete unecessary columns
```

## Manipulate data and visualize

```{r overview crops}
# average yield per crop
mn_crop = fin %>% 
  group_by(crop,cropcat) %>%
  summarise(mn_dt = mean(dtha)) %>%
  arrange(cropcat)
arrange(mn_crop, cropcat)
# TODO arrange plot for crop categories
ggplot(mn_crop, aes(x=crop,y=mn_dt,  fill = cropcat)) + 
  geom_bar(stat = 'identity', width = 0.8) +
  theme(axis.text.x = element_text(angle = 45, size = 9, vjust = 1, hjust = 1)) +
  labs(fill = 'crop category', y = 'dt/ha', x = '') +
  scale_fill_brewer(palette='RdYlBu') +
  ggtitle('Fig.1 Average yield of crops')

ggplot(mn_crop, aes(x=cropcat,y=mn_dt,  fill = cropcat)) + 
  geom_bar(stat = 'identity', width = 0.8) +
  theme(axis.text.x = element_text(angle = 45, size = 9, vjust = 1, hjust = 1), legend.position ='none') +
  labs(fill = 'crop categoy', y = 'dt/ha', x = '') +
  scale_fill_brewer(palette='RdYlBu') +
  ggtitle('Fig.2 Average yield per crop category')
  
# average yield per district
mn_kreis = fin %>%
  group_by(gen) %>%
  summarise(mn_dt = mean(dtha))

# average yield per crop per district
mn_cropkreis = fin %>%
  group_by(crop, gen) %>%
  summarise(mn_dt = mean(dtha))
```

```{r overview year}
# average yield per year
mn_jahr = fin %>%
  group_by(year) %>%
  summarise(mn_dt = mean(dtha))

ggplot(mn_jahr, aes(x=year,y=mn_dt)) + 
  geom_bar(stat = 'identity', width =0.8) +
  theme(axis.text.x = element_text(angle = 45, size = 9, vjust = 1, hjust = 1)) +
  ggtitle('Fig.3 Average yield per year')

# average yield per crop per year
mn_cropjahr = fin %>%
  group_by(year, crop) %>%
  summarise(mn_dt = mean(dtha))
cropnmsyear = unique(mn_cropjahr$crop)
mn_cropjahr$year = as.factor(mn_cropjahr$year)

#TODO crops over 100dt/ha in legend. Other crops withoout legend (or colours)
ggplot() +
  ggtitle('Fig.4 Average yield of crops for each year from 2005 to 2015') +
  geom_point(filter(mn_cropjahr,mn_dt>100),aes(x=year,y=mn_dt, group = crop, colour = crop)) +
  geom_line(filter(mn_cropjahr,mn_dt>100),aes(x=year,y=mn_dt, group = crop, colour = crop)) +
  theme(axis.text.x = element_text(angle = 90, size = 9, vjust = 0)) +
  scale_colour_discrete(name  ='crop', l=60, breaks=cropnmsyear, labels=cropnmsyear) +
  geom_point(filter(mn_cropjahr,mn_dt<100), aes(x=year,y=mn_dt, group=crop)) +
  geom_line(filter(mn_cropjahr,mn_dt<100), aes(x=year,y=mn_dt, group=crop)) +
  geom_smooth(filter(mn_cropjahr,mn_dt<100), aes(group = crop), method = 'lm', se = TRUE) +
  theme(axis.text.x = element_text(angle = 90, size = 9, vjust = 0))
```

The graph shows, that some previously largely harvested crops fell significantly in yield below the 100 dt per ha mark.
Therefore a distinction between the years from 2005 to 2006, from 2007 to 2009 and from 2010 to 2015 could be useful.

To have a glimpse over the geogrpahical distribution of yield districtwise we plotted a map-visual approach and a facet-barplot approach. We used the abbreviations of districts for license plates to shorten the district names for plots. The assignment code can be found below (dataframe 'abbcode').

```{r crops of district}
# TODO table for abbreviation c
unique(fin$gen)
fin = fin %>%
  mutate(gn = plyr::mapvalues(gen, 
            from= unique(fin$gen), 
            to=c('D','DU','E','KR','MG','MH','OB','RS','SG','W','KLE','ME','NE','VIE','WES','BN','K','LEV','AC','DN','BM','EU','HS','GM','GL','SU','BOT','GE','MS','BOR','COE','RE','ST','WAF','BI','GT','HF','HX','LIP','MI', 'PB', 'BO','DO','HA','HAM','HER','EN','HSK','LS','OE','SI','SO','UN')))
abbcode = data.frame(gen = unique(fin$gen), gn = unique(fin$gn))
abbcode
# average yield of each categorized crops per district
#TODO maybe more elegant solution with tmap
l = list()
fincropkreis = fin %>%
  select(cropcat, gen, gn, dtha)
for (i in 1:length(cropcatnms)){
mn_cropkreis = fincropkreis %>%
  group_by(cropcat,gen) %>%
  summarise(mn_dt = mean(dtha)) %>%
  filter(cropcat == cropcatnms[i])
  l[[i]] =  ggplot(data = mn_cropkreis) +
  geom_sf(aes(fill = mn_dt)) + 
    scale_fill_gradient2(midpoint = 32, low='blue', mid='yellow', high = 'red') +
  ggtitle(cropcatnms[i])#, subtitle = 'yield in dt per ha')
  if(i==length(cropcatnms)){ 
    l[[i]] = l[[i]] + theme(axis.text = element_blank(), axis.ticks = element_blank()) + guide_legend() 
  }
  else {
    l[[i]] = l[[i]] + theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.position = 'none')
  }
}
do.call(grid.arrange, c(l, top='Fig.5 Average yield of each crop category mapped for each district'))
# facetting approach
mn_cropkreisf = fin %>%
  group_by(cropcat,gn) %>%
  summarise(mn_dt = mean(dtha))
ggplot(mn_cropkreisf, aes(x=cropcat, y=mn_dt, fill = cropcat))+
  geom_bar(stat='identity') +
  facet_wrap(~gn, ncol = 10) +
  labs(fill = 'crop category', y = 'dt/ha', x = '') +
  scale_fill_brewer(palette='RdYlBu') +
  ggtitle('Fig.6 Average yield per crop category for each district') + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.text.y = element_text(size = 6))
```

```{r crop index}
# TODO Auswahl der Kategorien und Berechnung eines Index
cropindex06 = fin %>%
  filter(year==2005|2006) %>%
  group_by(gen) %>%
  summarise(mn_dt=mean(dtha))
  
cropindex09 = fin %>%
  filter(year==2007|2008|2009) %>%
  group_by(gen) %>%
  summarise(mn_dt=mean(dtha))

cropindex15 = fin %>%
  filter(year>=2010) %>%
  group_by(gen) %>%
  summarise(mn_dt=mean(dtha))

# TODO Visualisierung
tm_shape(nrw) + tm_borders(lwd = 2, col='grey1') + tm_compass() + tm_shape(cropindex06) + tm_polygons('mn_dt', palette='RdYlBu', breaks = c(0,20,40,60,80,100,120),id='dt/ha')
tm_shape(nrw) + tm_borders(lwd = 2, col='grey1') + tm_compass() + tm_shape(cropindex09) + tm_polygons('mn_dt', palette='RdYlBu', breaks = c(0,20,40,60,80,100,120),id='dt/ha')
tm_shape(nrw) + tm_borders(lwd = 2, col='grey1') + tm_compass() + tm_shape(cropindex15) + tm_polygons('mn_dt', palette='RdYlBu', breaks = c(0,20,40,60,80,100,120), id='dt/ha')
```

## Merge with pesticide data

To compare the crop yield with the pesticide usage, the sum of pesticide sample values were calculated for each district.

```{r data-spatial-pesticides}
nrw2 = readRDS(file.path('data/nrw', 'nrw_sites.rds')) # spatial sites data
nrw_sam = readRDS(file.path('data/nrw', 'nrw_samples.rds')) # pesticide samples
nrw_sam$site_id = gsub('_....-..-..','',nrw_sam$sample_id)
pest = merge(nrw2, nrw_sam)

# #Summe der Messwerte pro Site
# sum_pest = pest %>%
#   group_by(site_id) %>%
#   mutate(sum_value = sum(value, na.rm = TRUE))

#TODO Intersection 
st_crs(pest)
st_crs(mn_kreis)
mn_kreis = st_transform(mn_kreis, crs = st_crs(pest))
pestcrop = st_intersection(pest, mn_kreis) #insert crop index dataframe here

#TODO calculate pest index
 
#TODO visualize

```

## Tasks

- Part1:
  - Clean crop data
  - Merge with spatial data
  - Aggregate crop data
  - Select 5-10 regions (i.e. Kreis) with the most agriculture
  - Visualize regions with intensive agriculture

- Part2:
  - Intersect with pesticide sampling sites
  - Look if sites with high concentrations intersect well with regions (i.e. Kreis) with high agriculture
  - Visualize this

- Document this in R-Markdown
- Presentation?


